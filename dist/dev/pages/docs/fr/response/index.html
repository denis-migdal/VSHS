<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="utf8"/>
        <title>VSHS</title>
        <!--
        <meta name="theme-color" media="(prefers-color-scheme: light)" content="cyan" />
        <meta name="theme-color" media="(prefers-color-scheme: dark)" content="black" />
        -->
        <meta name="color-scheme" content="dark light">
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <link   href="./index.css"  rel="stylesheet" blocking="render">
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/brython/3.13.0/brython.min.js"></script>
        <script  src="./index.js"  type="module"     blocking="render" async></script>
    </head>
    <body>
        <main>

<h1 id="construire-une-r√©ponse-http-√†-retourner">Construire une r√©ponse HTTP (√† retourner)</h1>
<p>Pour r√©pondre √† une requ√™te HTTP, il suffit de retourner une instance de <a href="https://developer.mozilla.org/fr/docs/Web/API/Response"><code>Response</code></a>.</p>
<h2 id="indiquer-le-contenu-de-la-r√©ponse">Indiquer le contenu de la r√©ponse</h2>
<p>En g√©n√©ral vous souhaiterez envoyer des donn√©es au format JSON gr√¢ce √† la <strong>m√©thode statique</strong> <code>Response.json()</code> :</p>
<vshs-playground name="response (json)" show="index.code,output">
</vshs-playground>
<div style="text-align:right"><a href="../../../playground/?example=response (json)"><i>Tester l'exemple dans le bac √† sable</i></a></div>

<p>Vous pouvez aussi utiliser le <strong>constructeur</strong> de <code>Response</code> afin d&#39;envoyer diff√©rent types de donn√©es (cliquez pour afficher) :</p>
<details>
    <summary><b>Texte</b> : avec <js-code>string</js-code>.</summary>
    <vshs-playground name="response (string)" show="index.code,output">
</vshs-playground>
<div style="text-align:right"><a href="../../../playground/?example=response (string)"><i>Tester l'exemple dans le bac √† sable</i></a></div>
</details>
<details>
    <summary><b>Paires clefs-valeurs</b> : avec <a href="https://developer.mozilla.org/fr/docs/Web/API/URLSearchParams"><js-code>URLSearchParams</js-code></a> ou <a href="https://developer.mozilla.org/fr/docs/Web/API/FormData"><js-code>FormData</js-code></a>.</summary>
    <vshs-playground name="response (URLSearchParams)" show="index.code,output">
</vshs-playground>
<div style="text-align:right"><a href="../../../playground/?example=response (URLSearchParams)"><i>Tester l'exemple dans le bac √† sable</i></a></div>
    <vshs-playground name="response (FormData)" show="index.code,output">
</vshs-playground>
<div style="text-align:right"><a href="../../../playground/?example=response (FormData)"><i>Tester l'exemple dans le bac √† sable</i></a></div>
    üí° Pr√©f√©rez les <js-code>URLFormParams</js-code> aux <js-code>FormData</js-code>, le format de ces derniers changeant en fonction de la plateforme utilis√©e.
</details>
<details>
    <summary><b>Donn√©es binaires</b> : usuellement avec <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array"><js-code>Uint8Array</js-code></a>, mais aussi <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer"><js-code>ArrayBuffer</js-code></a>, <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/TypedArray"><js-code>TypedArray</js-code></a>, ou <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/DataView"><js-code>DataView</js-code></a>.</summary>
    <vshs-playground name="response (Uint8Array)" show="index.code,output">
</vshs-playground>
<div style="text-align:right"><a href="../../../playground/?example=response (Uint8Array)"><i>Tester l'exemple dans le bac √† sable</i></a></div>
</details>
<details>
    <summary><b>Fichiers</b> : avec <a href="https://developer.mozilla.org/fr/docs/Web/API/Blob"><js-code>Blob</js-code></a> ou <a href="https://developer.mozilla.org/fr/docs/Web/API/File"><js-code>File</js-code></a>.</summary>
    <vshs-playground name="response (Blob)" show="index.code,output">
</vshs-playground>
<div style="text-align:right"><a href="../../../playground/?example=response (Blob)"><i>Tester l'exemple dans le bac √† sable</i></a></div>
</details>
<details>
    <summary><b>Flux</b> : avec <a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream"><js-code>ReadableStream</js-code></a>.</summary>
    Cf <a href="#flux-et-server-sent-events">Flux et Server-Sent Events</a>.
</details>

<p>üí° Si vous ne retournez aucun <js-code>Response</js-code>, VSHS en retournera un automatiquement :</p>
<vshs-playground name="response (none)" show="index.code,output">
</vshs-playground>
<div style="text-align:right"><a href="../../../playground/?example=response (none)"><i>Tester l'exemple dans le bac √† sable</i></a></div>

<p>üí° Pour des r√©ponses constantes, vous pouvez construire un <js-code>Response</js-code> global que vous clonerez dans le <em>request handler</em> :
<vshs-playground name="response (clone)" show="index.code,output">
</vshs-playground></p>
<div style="text-align:right"><a href="../../../playground/?example=response (clone)"><i>Tester l'exemple dans le bac √† sable</i></a></div>

<h2 id="gestion-des-erreurs">Gestion des erreurs</h2>
<h3 id="codes-de-status-http">Codes de status HTTP</h3>
<p>Lors de la construction d&#39;un <code>Response</code>, il est possible d&#39;indiquer un code de status HTTP ainsi qu&#39;un texte descriptif :
<vshs-playground name="response (status)" show="index.code,output">
</vshs-playground></p>
<div style="text-align:right"><a href="../../../playground/?example=response (status)"><i>Tester l'exemple dans le bac √† sable</i></a></div>

<p>‚ö† Actuellement, Deno ne supporte pas les <code>statusText</code> personnalis√©s.</p>
<p>üí° Vous pouvez aussi lancer (<em>throw</em>) un <code>Response</code> qui sera automatiquement retourn√© :
<vshs-playground name="response (throw response)" show="index.code,output">
</vshs-playground></p>
<div style="text-align:right"><a href="../../../playground/?example=response (throw response)"><i>Tester l'exemple dans le bac √† sable</i></a></div>

<h3 id="erreurs-et-exceptions">Erreurs et Exceptions</h3>
<p>Par d√©faut, les exceptions/erreurs lanc√©es qui ne sont pas des <code>Response</code> sont convertis en une <code>Response</code> avec un status 500 et un corps contenant le message d&#39;erreur (statusText n&#39;√©tant pas support√© par Deno) :
<vshs-playground name="response (error)" show="index.code,output">
</vshs-playground></p>
<div style="text-align:right"><a href="../../../playground/?example=response (error)"><i>Tester l'exemple dans le bac √† sable</i></a></div>

<h3 id="redirections">Redirections</h3>
<p>üí° Vous pouvez effectuer une redirection gr√¢ce √† la <strong>m√©thode statique</strong> <code>Response.redirect()</code> :
<vshs-playground name="response (redirect)" show="index.code,output">
</vshs-playground></p>
<div style="text-align:right"><a href="../../../playground/?example=response (redirect)"><i>Tester l'exemple dans le bac √† sable</i></a></div>

<p>Son premier param√®tre est l&#39;URL vers laquelle rediriger, et son second param√®tre (facultatif) le code de status HTTP :</p>
<ul>
<li><code>307</code> : redirection temporaire ;</li>
<li><code>308</code> : redirection permanente.</li>
</ul>
<h2 id="en-t√™te">En-t√™te</h2>
<p>[TODO]</p>
<h2 id="flux-et-server-sent-events">Flux et Server-Sent Events</h2>
<p>Il est aussi possible de retourner des flux gr√¢ce √† l&#39;<a href="https://developer.mozilla.org/en-US/docs/Web/API/Streams_API">API Streams</a>. Elle permet des op√©rations de bas niveau sur les flux :</p>
<ul>
<li>l&#39;encodage/d√©codage d&#39;un flux avec <a href="https://developer.mozilla.org/en-US/docs/Web/API/TextEncoderStream"><code>TextEncoderStream</code></a>/<a href="https://developer.mozilla.org/en-US/docs/Web/API/TextDecoderStream"><code>TextDecoderStream</code></a>.</li>
<li>la compression/d√©compression d&#39;un flux avec <a href="https://developer.mozilla.org/en-US/docs/Web/API/CompressionStream"><code>CompressionStream</code></a>/<a href="https://developer.mozilla.org/en-US/docs/Web/API/DecompressionStream"><code>DecompressionStream</code></a>.</li>
<li>ainsi que des op√©rations arbitraires via <a href="https://developer.mozilla.org/en-US/docs/Web/API/TransformStream"><code>TransformStream</code></a>.</li>
</ul>
<details>
    <summary>Cliquez ici pour afficher un exemple de flux.</summary>
    <vshs-playground name="response (stream)" show="index.code,output">
    </vshs-playground>
    <div style="text-align:right"><a href="../../../playground/?example=response (stream)"><i>Tester l'exemple dans le bac √† sable</i></a></div>
</details>

<p>üí° Pour des op√©rations de haut niveau, il convient d&#39;utiliser des designs patterns d√©corateurs sur <code>writable.getWriter()</code> et <code>readable.getReader()</code> :</p>
<details>
    <summary>Cliquez ici pour afficher un exemple d'impl√©mentation de Server-Sent Events.</summary>
    <vshs-playground name="response (SSE)" show="index.code,output">
    </vshs-playground>
    <div style="text-align:right"><a href="../../../playground/?example=response (SSE)"><i>Tester l'exemple dans le bac √† sable</i></a></div>
</details>

<p>üí° VSHS fournit un <em>helper</em> permettant d&#39;ais√©ment retourner une r√©ponse Server-Sent Event :
<vshs-playground name="response (SSE Helper)" show="index.code,output">
</vshs-playground></p>
<div style="text-align:right"><a href="../../../playground/?example=response (SSE Helper)"><i>Tester l'exemple dans le bac √† sable</i></a></div>

<p><code>SSEResponse</code> prend en param√®tre :</p>
<ul>
<li>un callback appel√© avec <code>writer</code> et <code>..args</code> en param√®tres ;</li>
<li>(facultatif) un <code>ResponseInit</code> permettant de configurer le <code>Response</code>;</li>
<li>(facultatif) une liste d&#39;arguments <code>...args</code> transmis au callback.</li>
</ul>
<h2 id="websockets">Websockets</h2>
<p>Les <a href="https://developer.mozilla.org/fr/docs/Web/API/WebSocket"><code>WebSocket</code></a> permettent des communications bidirectionnelles asynchrones entre le navigateur et le serveur :</p>
<ul>
<li><code>send(data)</code> permet d&#39;envoyer des donn√©es ;</li>
<li><code>addEventListener(&#39;message&#39;, ({data}) =&gt; {})</code> permet d&#39;√©couter les donn√©es re√ßues.</li>
</ul>
<vshs-playground name="response (WebSocket)" show="index.code,output">
</vshs-playground>
<div style="text-align:right"><a href="../../../playground/?example=response (WebSocket)"><i>Tester l'exemple dans le bac √† sable</i></a></div>

<p>‚ö† Vous devez attendre que la connexion soit ouverte avant d&#39;envoyer des donn√©es (i.e. attendre l&#39;√©v√©nement <code>open</code>).</p>
<p>üí° Progressivement, les WebSockets ont vocation √† √™tre remplac√©s par l&#39;API <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebTransport_API"><code>WebTransport</code></a>. Cependant, comme pour les flux, il s&#39;agit d&#39;une API bas niveau.</p>
</main>
    </body>
</html>